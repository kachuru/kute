#!/usr/bin/php
<?php
$opts = getopt('hf:n::s::');

// Strip out args from argv
foreach ($argv as $i => $arg) {
    if ($i != 0) {
        if (substr($arg, 0, 1) == '-' && array_key_exists(substr($arg, 1, 1), $opts)) {
            unset($argv[$i]);
        }
    }
}
$argv = array_values($argv);

$preserveHeaders  = array_key_exists('h', $opts);
$file = $argv[1];

if (!file_exists($file)) {
    die("File '{$file}' does not exist\n");
}

if (isset($opts['n'])) {
    if (!is_numeric($opts['n'])) {
        die("Must specify number of files to split to\n");
    }
    $num = $opts['n'];
} else {
    $num = 2;
}

if (isset($opts['s'])) {
    $sep = $opts['s'];
} else {
    $sep = ',';
}

if (!is_writable('.')) {
    die("Unable to write to current directory\n");
}

$fileinfo = pathinfo($file);

for ($i = 0; $i < $num; $i++) {
    $filenames[$i] = $fileinfo['filename'] . '.' . ($i+1);
    if (!empty($fileinfo['extension'])) {
        $filenames[$i] .= '.' . $fileinfo['extension'];
    }
}

$fp = fopen($file, 'r');

$pos = 0;
if ($preserveHeaders) {
    $headers = fgetcsv($fp, 0, $sep);
    $pos = ftell($fp);
}

$lines = 0;
while (false !== ($line = fgetcsv($fp, 0, $sep))) {
    $lines++;
}
$size = ceil($lines / $num);

fseek($fp, $pos);

$whichfile = 0;
$linenumber = 0;
while (false !== ($line = fgetcsv($fp, 0, $sep))) {
    if ($linenumber == 0 && $preserveHeaders) {
        $fpw = fopen($filenames[$whichfile], 'w+');
        fputcsv($fpw, $headers, $sep);
    }

    fputcsv($fpw, $line, $sep);
    $linenumber++;

    if ($linenumber >= $size) {
        fclose($fpw);

        $whichfile++;
        $linenumber = 0;

        if ($whichfile == $num) {
            die("File out of range (too many records)\n");
        }
    }
}

fclose($fp);
